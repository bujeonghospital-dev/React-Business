# üìû ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ô‡∏≥ "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤" ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö Python API

## üéØ ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°

‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏ô‡∏µ‡πâ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Python API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤" (Call Matrix) ‡∏ó‡∏µ‡πà:

- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£‡∏Ç‡∏≠‡∏á Agent (101-108) ‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (9:00-20:00)
- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
- Deploy ‡∏ö‡∏ô Railway (Python API)
- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö Next.js Frontend ‡∏ö‡∏ô Vercel

---

## üìä ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

### Google Sheets Structure

**Sheet Name:** `‡∏™‡∏£‡∏∏‡∏õ call_AI_summary`

| Agent | 9-10 | 10-11 | 11-12 | 12-13 | 13-14 | 14-15 | 15-16 | 16-17 | 17-18 | 18-19 | 19-20 | ‡∏£‡∏ß‡∏° |
| ----- | ---- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | --- |
| 101   | 5    | 8     | 12    | 10    | 15    | 9     | 11    | 8     | 6     | 4     | 3     | 91  |
| 102   | 6    | 7     | 10    | 11    | 13    | 8     | 10    | 9     | 5     | 3     | 2     | 84  |
| ...   | ...  | ...   | ...   | ...   | ...   | ...   | ...   | ...   | ...   | ...   | ...   | ... |

**‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:**

- ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏Ñ‡∏∑‡∏≠‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡πâ‡∏ô
- ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠ Agent
- ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ï‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤

---

## üêç Python API Implementation

### 1. ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå

```
python-api/
‚îú‚îÄ‚îÄ app.py                    # Main Flask application
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ google_sheets.py      # Google Sheets service
‚îÇ   ‚îî‚îÄ‚îÄ call_matrix.py        # Call Matrix logic
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ call_log.py           # Data models
‚îú‚îÄ‚îÄ requirements.txt          # Python dependencies
‚îú‚îÄ‚îÄ Procfile                  # Railway deployment
‚îú‚îÄ‚îÄ railway.json              # Railway config
‚îú‚îÄ‚îÄ runtime.txt               # Python version
‚îî‚îÄ‚îÄ .env.example              # Environment variables template
```

### 2. ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Dependencies

**requirements.txt:**

```txt
Flask==3.0.0
flask-cors==4.0.0
google-auth==2.25.2
google-auth-oauthlib==1.2.0
google-auth-httplib2==0.2.0
gspread==5.12.1
python-dotenv==1.0.0
gunicorn==21.2.0
pytz==2023.3
```

**‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á:**

```bash
cd python-api
pip install -r requirements.txt
```

---

## üìù Code Implementation

### 3. Google Sheets Service (services/google_sheets.py)

```python
import os
import gspread
from google.oauth2.service_account import Credentials
from datetime import datetime
import pytz

class GoogleSheetsService:
    def __init__(self):
        # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ credentials
        self.credentials = self._get_credentials()
        self.client = gspread.authorize(self.credentials)
        self.spreadsheet_id = os.getenv('GOOGLE_SPREADSHEET_ID')

    def _get_credentials(self):
        """‡∏™‡∏£‡πâ‡∏≤‡∏á credentials ‡∏à‡∏≤‡∏Å environment variables"""
        scopes = [
            'https://www.googleapis.com/auth/spreadsheets',
            'https://www.googleapis.com/auth/drive'
        ]

        credentials_info = {
            "type": "service_account",
            "project_id": os.getenv('GOOGLE_PROJECT_ID'),
            "private_key_id": os.getenv('GOOGLE_PRIVATE_KEY_ID'),
            "private_key": os.getenv('GOOGLE_SERVICE_ACCOUNT_PRIVATE_KEY').replace('\\n', '\n'),
            "client_email": os.getenv('GOOGLE_SERVICE_ACCOUNT_EMAIL'),
            "client_id": os.getenv('GOOGLE_CLIENT_ID'),
            "auth_uri": "https://accounts.google.com/o/oauth2/auth",
            "token_uri": "https://oauth2.googleapis.com/token",
            "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
            "client_x509_cert_url": os.getenv('GOOGLE_CLIENT_CERT_URL')
        }

        return Credentials.from_service_account_info(credentials_info, scopes=scopes)

    def get_spreadsheet(self):
        """‡πÄ‡∏õ‡∏¥‡∏î spreadsheet"""
        return self.client.open_by_key(self.spreadsheet_id)

    def get_worksheet(self, sheet_name):
        """‡πÄ‡∏õ‡∏¥‡∏î worksheet ‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠"""
        spreadsheet = self.get_spreadsheet()
        return spreadsheet.worksheet(sheet_name)

    def read_call_matrix(self, date=None):
        """‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Call Matrix ‡∏à‡∏≤‡∏Å Google Sheets

        Args:
            date: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DD (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)

        Returns:
            dict: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• call matrix
        """
        if date is None:
            bangkok_tz = pytz.timezone('Asia/Bangkok')
            date = datetime.now(bangkok_tz).strftime('%Y-%m-%d')

        try:
            # ‡πÄ‡∏õ‡∏¥‡∏î worksheet
            worksheet = self.get_worksheet('‡∏™‡∏£‡∏∏‡∏õ call_AI_summary')

            # ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            all_values = worksheet.get_all_values()

            if len(all_values) < 2:
                return {"error": "No data found"}

            # ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô format ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
            headers = all_values[0]  # ['Agent', '9-10', '10-11', ...]
            time_slots = headers[1:-1]  # ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤ Agent ‡πÅ‡∏•‡∏∞ ‡∏£‡∏ß‡∏°)

            matrix_data = {}
            totals_by_agent = {}
            totals_by_slot = {slot: 0 for slot in time_slots}

            for row in all_values[1:]:  # ‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                if not row or len(row) < 2:
                    continue

                agent_id = row[0]
                if not agent_id or agent_id == '‡∏£‡∏ß‡∏°':
                    continue

                matrix_data[agent_id] = {}
                agent_total = 0

                for i, slot in enumerate(time_slots, start=1):
                    try:
                        value = int(row[i]) if row[i] else 0
                    except (ValueError, IndexError):
                        value = 0

                    matrix_data[agent_id][slot] = value
                    agent_total += value
                    totals_by_slot[slot] += value

                totals_by_agent[agent_id] = agent_total

            return {
                "success": True,
                "date": date,
                "time_slots": time_slots,
                "matrix_data": matrix_data,
                "totals_by_agent": totals_by_agent,
                "totals_by_slot": totals_by_slot,
                "grand_total": sum(totals_by_agent.values())
            }

        except Exception as e:
            return {
                "success": False,
                "error": str(e)
            }

    def update_call_count(self, agent_id, time_slot, increment=1):
        """‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î

        Args:
            agent_id: ‡∏£‡∏´‡∏±‡∏™ agent (‡πÄ‡∏ä‡πà‡∏ô '101', '102')
            time_slot: ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô '9-10', '10-11')
            increment: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° (default=1)

        Returns:
            dict: ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó
        """
        try:
            worksheet = self.get_worksheet('‡∏™‡∏£‡∏∏‡∏õ call_AI_summary')

            # ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á agent ‡πÅ‡∏•‡∏∞ time slot
            all_values = worksheet.get_all_values()
            headers = all_values[0]

            # ‡∏´‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡∏≠‡∏á time_slot
            try:
                col_index = headers.index(time_slot) + 1  # +1 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ gspread ‡∏ô‡∏±‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏° 1
            except ValueError:
                return {
                    "success": False,
                    "error": f"Time slot '{time_slot}' not found"
                }

            # ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏≠‡∏á agent
            row_index = None
            for i, row in enumerate(all_values[1:], start=2):  # ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏ó‡∏µ‡πà 2 (‡∏Ç‡πâ‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á)
                if row[0] == agent_id:
                    row_index = i
                    break

            if row_index is None:
                return {
                    "success": False,
                    "error": f"Agent '{agent_id}' not found"
                }

            # ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            current_value = worksheet.cell(row_index, col_index).value
            try:
                current_value = int(current_value) if current_value else 0
            except ValueError:
                current_value = 0

            # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà
            new_value = current_value + increment

            # ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà
            worksheet.update_cell(row_index, col_index, new_value)

            return {
                "success": True,
                "agent_id": agent_id,
                "time_slot": time_slot,
                "old_value": current_value,
                "new_value": new_value,
                "increment": increment
            }

        except Exception as e:
            return {
                "success": False,
                "error": str(e)
            }

    def batch_update_call_counts(self, updates):
        """‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô

        Args:
            updates: list of dict [{"agent_id": "101", "time_slot": "9-10", "value": 5}, ...]

        Returns:
            dict: ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó
        """
        try:
            worksheet = self.get_worksheet('‡∏™‡∏£‡∏∏‡∏õ call_AI_summary')
            all_values = worksheet.get_all_values()
            headers = all_values[0]

            # ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° batch update
            batch_data = []

            for update in updates:
                agent_id = update.get('agent_id')
                time_slot = update.get('time_slot')
                new_value = update.get('value', 0)

                # ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                try:
                    col_index = headers.index(time_slot) + 1
                except ValueError:
                    continue

                row_index = None
                for i, row in enumerate(all_values[1:], start=2):
                    if row[0] == agent_id:
                        row_index = i
                        break

                if row_index is None:
                    continue

                # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ batch
                batch_data.append({
                    'range': worksheet.title + '!' + gspread.utils.rowcol_to_a1(row_index, col_index),
                    'values': [[new_value]]
                })

            # ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
            if batch_data:
                worksheet.spreadsheet.values_batch_update(batch_data)

            return {
                "success": True,
                "updated_count": len(batch_data)
            }

        except Exception as e:
            return {
                "success": False,
                "error": str(e)
            }
```

### 4. Call Matrix Service (services/call_matrix.py)

```python
from datetime import datetime
import pytz

class CallMatrixService:
    def __init__(self, sheets_service):
        self.sheets = sheets_service

    def get_current_time_slot(self):
        """‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô

        Returns:
            str: ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô '9-10', '10-11'
        """
        bangkok_tz = pytz.timezone('Asia/Bangkok')
        now = datetime.now(bangkok_tz)
        hour = now.hour

        # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (9-20) return None
        if hour < 9 or hour >= 20:
            return None

        return f"{hour}-{hour + 1}"

    def log_call(self, agent_id, call_type='outgoing', time_slot=None):
        """‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£

        Args:
            agent_id: ‡∏£‡∏´‡∏±‡∏™ agent
            call_type: ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£ ('outgoing', 'incoming', 'missed')
            time_slot: ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)

        Returns:
            dict: ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        """
        if time_slot is None:
            time_slot = self.get_current_time_slot()

        if time_slot is None:
            return {
                "success": False,
                "error": "Not in working hours (9:00-20:00)"
            }

        # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets
        result = self.sheets.update_call_count(agent_id, time_slot, increment=1)

        return result

    def get_call_matrix(self, date=None):
        """‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Call Matrix

        Args:
            date: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (YYYY-MM-DD)

        Returns:
            dict: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• call matrix
        """
        return self.sheets.read_call_matrix(date)

    def get_agent_summary(self, agent_id, date=None):
        """‡∏î‡∏∂‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£‡∏Ç‡∏≠‡∏á agent ‡∏Ñ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á

        Args:
            agent_id: ‡∏£‡∏´‡∏±‡∏™ agent
            date: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà

        Returns:
            dict: ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£
        """
        matrix = self.sheets.read_call_matrix(date)

        if not matrix.get('success'):
            return matrix

        agent_data = matrix.get('matrix_data', {}).get(agent_id)
        if not agent_data:
            return {
                "success": False,
                "error": f"Agent {agent_id} not found"
            }

        return {
            "success": True,
            "agent_id": agent_id,
            "date": matrix.get('date'),
            "calls_by_slot": agent_data,
            "total_calls": matrix.get('totals_by_agent', {}).get(agent_id, 0)
        }

    def get_time_slot_summary(self, time_slot, date=None):
        """‡∏î‡∏∂‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏ô‡∏∂‡πà‡∏á

        Args:
            time_slot: ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô '9-10')
            date: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà

        Returns:
            dict: ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£
        """
        matrix = self.sheets.read_call_matrix(date)

        if not matrix.get('success'):
            return matrix

        slot_data = {}
        for agent_id, calls in matrix.get('matrix_data', {}).items():
            slot_data[agent_id] = calls.get(time_slot, 0)

        return {
            "success": True,
            "time_slot": time_slot,
            "date": matrix.get('date'),
            "calls_by_agent": slot_data,
            "total_calls": matrix.get('totals_by_slot', {}).get(time_slot, 0)
        }
```

### 5. Flask API Routes (app.py)

```python
from flask import Flask, request, jsonify
from flask_cors import CORS
from dotenv import load_dotenv
import os
from datetime import datetime
import pytz

# Import services
from services.google_sheets import GoogleSheetsService
from services.call_matrix import CallMatrixService

# Load environment variables
load_dotenv()

# Initialize Flask app
app = Flask(__name__)
CORS(app)  # Enable CORS for all routes

# Initialize services
sheets_service = GoogleSheetsService()
call_matrix_service = CallMatrixService(sheets_service)

# Health check endpoint
@app.route('/health', methods=['GET'])
def health_check():
    bangkok_tz = pytz.timezone('Asia/Bangkok')
    return jsonify({
        'status': 'healthy',
        'timestamp': datetime.now(bangkok_tz).isoformat(),
        'service': 'Call Matrix API'
    })

# ========================================
# Call Matrix Endpoints
# ========================================

@app.route('/api/call-matrix', methods=['GET'])
def get_call_matrix():
    """‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Call Matrix ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

    Query Parameters:
        date (optional): ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DD

    Example:
        GET /api/call-matrix?date=2025-11-18
    """
    date = request.args.get('date')
    result = call_matrix_service.get_call_matrix(date)

    status_code = 200 if result.get('success') else 500
    return jsonify(result), status_code

@app.route('/api/call-matrix/agent/<agent_id>', methods=['GET'])
def get_agent_summary(agent_id):
    """‡∏î‡∏∂‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£‡∏Ç‡∏≠‡∏á agent ‡∏Ñ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á

    Path Parameters:
        agent_id: ‡∏£‡∏´‡∏±‡∏™ agent (‡πÄ‡∏ä‡πà‡∏ô '101', '102')

    Query Parameters:
        date (optional): ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà

    Example:
        GET /api/call-matrix/agent/101?date=2025-11-18
    """
    date = request.args.get('date')
    result = call_matrix_service.get_agent_summary(agent_id, date)

    status_code = 200 if result.get('success') else 404
    return jsonify(result), status_code

@app.route('/api/call-matrix/time-slot/<time_slot>', methods=['GET'])
def get_time_slot_summary(time_slot):
    """‡∏î‡∏∂‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏ô‡∏∂‡πà‡∏á

    Path Parameters:
        time_slot: ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô '9-10', '10-11')

    Query Parameters:
        date (optional): ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà

    Example:
        GET /api/call-matrix/time-slot/9-10?date=2025-11-18
    """
    date = request.args.get('date')
    result = call_matrix_service.get_time_slot_summary(time_slot, date)

    status_code = 200 if result.get('success') else 404
    return jsonify(result), status_code

@app.route('/api/call-matrix/log', methods=['POST'])
def log_call():
    """‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£

    Request Body:
        {
            "agent_id": "101",
            "call_type": "outgoing",  # optional, default: "outgoing"
            "time_slot": "9-10"       # optional, default: current time slot
        }

    Example:
        POST /api/call-matrix/log
        {
            "agent_id": "101"
        }
    """
    data = request.get_json()

    if not data or 'agent_id' not in data:
        return jsonify({
            "success": False,
            "error": "agent_id is required"
        }), 400

    agent_id = data.get('agent_id')
    call_type = data.get('call_type', 'outgoing')
    time_slot = data.get('time_slot')

    result = call_matrix_service.log_call(agent_id, call_type, time_slot)

    status_code = 200 if result.get('success') else 400
    return jsonify(result), status_code

@app.route('/api/call-matrix/update', methods=['POST'])
def update_call_count():
    """‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á

    Request Body:
        {
            "agent_id": "101",
            "time_slot": "9-10",
            "value": 5
        }

    Example:
        POST /api/call-matrix/update
        {
            "agent_id": "101",
            "time_slot": "9-10",
            "value": 5
        }
    """
    data = request.get_json()

    if not data:
        return jsonify({
            "success": False,
            "error": "Request body is required"
        }), 400

    required_fields = ['agent_id', 'time_slot', 'value']
    for field in required_fields:
        if field not in data:
            return jsonify({
                "success": False,
                "error": f"{field} is required"
            }), 400

    agent_id = data.get('agent_id')
    time_slot = data.get('time_slot')
    value = data.get('value')

    # ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°)
    result = sheets_service.update_call_count(
        agent_id,
        time_slot,
        increment=value  # ‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ logic ‡πÉ‡∏ô update_call_count ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ set ‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
    )

    status_code = 200 if result.get('success') else 400
    return jsonify(result), status_code

@app.route('/api/call-matrix/batch-update', methods=['POST'])
def batch_update_call_counts():
    """‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡πà‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô

    Request Body:
        {
            "updates": [
                {"agent_id": "101", "time_slot": "9-10", "value": 5},
                {"agent_id": "102", "time_slot": "10-11", "value": 8}
            ]
        }
    """
    data = request.get_json()

    if not data or 'updates' not in data:
        return jsonify({
            "success": False,
            "error": "updates array is required"
        }), 400

    updates = data.get('updates', [])
    result = sheets_service.batch_update_call_counts(updates)

    status_code = 200 if result.get('success') else 400
    return jsonify(result), status_code

# Error handlers
@app.errorhandler(404)
def not_found(error):
    return jsonify({
        'success': False,
        'error': 'Endpoint not found'
    }), 404

@app.errorhandler(500)
def internal_error(error):
    return jsonify({
        'success': False,
        'error': 'Internal server error'
    }), 500

if __name__ == '__main__':
    port = int(os.getenv('PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=False)
```

---

## üîß ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Environment Variables

### .env.example

```bash
# Google Sheets Configuration
GOOGLE_SPREADSHEET_ID=your_spreadsheet_id_here
GOOGLE_PROJECT_ID=your_project_id
GOOGLE_PRIVATE_KEY_ID=your_private_key_id
GOOGLE_SERVICE_ACCOUNT_PRIVATE_KEY=-----BEGIN PRIVATE KEY-----\nYour_Private_Key_Here\n-----END PRIVATE KEY-----
GOOGLE_SERVICE_ACCOUNT_EMAIL=your-service-account@project.iam.gserviceaccount.com
GOOGLE_CLIENT_ID=your_client_id
GOOGLE_CLIENT_CERT_URL=https://www.googleapis.com/robot/v1/metadata/x509/your-service-account%40project.iam.gserviceaccount.com

# Server Configuration
PORT=5000
FLASK_ENV=production
```

### ‡∏ß‡∏¥‡∏ò‡∏µ‡∏´‡∏≤ Google Service Account Credentials

1. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà [Google Cloud Console](https://console.cloud.google.com/)
2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Project ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Project ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
3. ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Google Sheets API
4. ‡∏™‡∏£‡πâ‡∏≤‡∏á Service Account:
   - IAM & Admin ‚Üí Service Accounts ‚Üí Create Service Account
   - ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ Service Account (‡πÄ‡∏ä‡πà‡∏ô "call-matrix-api")
   - Grant permissions: Editor
5. ‡∏™‡∏£‡πâ‡∏≤‡∏á JSON Key:
   - ‡∏Ñ‡∏•‡∏¥‡∏Å Service Account ‚Üí Keys ‚Üí Add Key ‚Üí Create New Key ‚Üí JSON
   - ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå JSON
6. ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå JSON ‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô `.env`

---

## üöÄ ‡∏Å‡∏≤‡∏£ Deploy ‡∏ö‡∏ô Railway

### 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Railway

**Procfile:**

```
web: gunicorn app:app --bind 0.0.0.0:$PORT --workers 2 --timeout 120
```

**runtime.txt:**

```
python-3.11.5
```

**railway.json:**

```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "pip install -r requirements.txt"
  },
  "deploy": {
    "startCommand": "gunicorn app:app --bind 0.0.0.0:$PORT --workers 2 --timeout 120",
    "healthcheckPath": "/health",
    "healthcheckTimeout": 100,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

### 2. Deploy ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Railway

```bash
# 1. ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Railway CLI
npm install -g @railway/cli

# 2. Login
railway login

# 3. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå python-api
cd python-api

# 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á project
railway init

# 5. Deploy
railway up

# 6. ‡πÄ‡∏õ‡∏¥‡∏î Dashboard
railway open
```

### 3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Environment Variables ‡∏ö‡∏ô Railway

‡πÑ‡∏õ‡∏ó‡∏µ‡πà Railway Dashboard ‚Üí Variables ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°:

- `GOOGLE_SPREADSHEET_ID`
- `GOOGLE_PROJECT_ID`
- `GOOGLE_PRIVATE_KEY_ID`
- `GOOGLE_SERVICE_ACCOUNT_PRIVATE_KEY`
- `GOOGLE_SERVICE_ACCOUNT_EMAIL`
- `GOOGLE_CLIENT_ID`
- `GOOGLE_CLIENT_CERT_URL`

### 4. ‡∏£‡∏±‡∏ö Public URL

Railway ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥:

```
https://believable-ambition-production.up.railway.app
```

---

## üåê ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Next.js Frontend

### 1. ‡πÄ‡∏û‡∏¥‡πà‡∏° Environment Variable ‡πÉ‡∏ô Vercel

```bash
NEXT_PUBLIC_PYTHON_API_URL=https://believable-ambition-production.up.railway.app
```

### 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á API Client (utils/callMatrixApi.ts)

```typescript
const API_URL =
  process.env.NEXT_PUBLIC_PYTHON_API_URL || "http://localhost:5000";

export interface CallMatrixData {
  success: boolean;
  date: string;
  time_slots: string[];
  matrix_data: Record<string, Record<string, number>>;
  totals_by_agent: Record<string, number>;
  totals_by_slot: Record<string, number>;
  grand_total: number;
}

export interface LogCallRequest {
  agent_id: string;
  call_type?: "outgoing" | "incoming" | "missed";
  time_slot?: string;
}

export interface UpdateCallRequest {
  agent_id: string;
  time_slot: string;
  value: number;
}

// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Call Matrix
export async function fetchCallMatrix(date?: string): Promise<CallMatrixData> {
  const url = date
    ? `${API_URL}/api/call-matrix?date=${date}`
    : `${API_URL}/api/call-matrix`;

  const response = await fetch(url);

  if (!response.ok) {
    throw new Error(`Failed to fetch call matrix: ${response.statusText}`);
  }

  return response.json();
}

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£
export async function logCall(data: LogCallRequest) {
  const response = await fetch(`${API_URL}/api/call-matrix/log`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(data),
  });

  if (!response.ok) {
    throw new Error(`Failed to log call: ${response.statusText}`);
  }

  return response.json();
}

// ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£
export async function updateCallCount(data: UpdateCallRequest) {
  const response = await fetch(`${API_URL}/api/call-matrix/update`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(data),
  });

  if (!response.ok) {
    throw new Error(`Failed to update call count: ${response.statusText}`);
  }

  return response.json();
}

// ‡∏î‡∏∂‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏≠‡∏á Agent ‡∏Ñ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á
export async function fetchAgentSummary(agentId: string, date?: string) {
  const url = date
    ? `${API_URL}/api/call-matrix/agent/${agentId}?date=${date}`
    : `${API_URL}/api/call-matrix/agent/${agentId}`;

  const response = await fetch(url);

  if (!response.ok) {
    throw new Error(`Failed to fetch agent summary: ${response.statusText}`);
  }

  return response.json();
}
```

### 3. ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô Component

```typescript
"use client";

import { useState, useEffect } from "react";
import {
  fetchCallMatrix,
  logCall,
  updateCallCount,
} from "@/utils/callMatrixApi";

export default function CallMatrixDashboard() {
  const [matrixData, setMatrixData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [selectedDate, setSelectedDate] = useState(
    new Date().toISOString().split("T")[0]
  );

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  useEffect(() => {
    loadMatrix();
  }, [selectedDate]);

  async function loadMatrix() {
    try {
      setLoading(true);
      const data = await fetchCallMatrix(selectedDate);
      setMatrixData(data);
    } catch (error) {
      console.error("Error loading matrix:", error);
    } finally {
      setLoading(false);
    }
  }

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£
  async function handleLogCall(agentId: string) {
    try {
      await logCall({ agent_id: agentId });
      await loadMatrix(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    } catch (error) {
      console.error("Error logging call:", error);
    }
  }

  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£
  async function handleUpdateCell(
    agentId: string,
    timeSlot: string,
    value: number
  ) {
    try {
      await updateCallCount({
        agent_id: agentId,
        time_slot: timeSlot,
        value: value,
      });
      await loadMatrix(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    } catch (error) {
      console.error("Error updating cell:", error);
    }
  }

  if (loading) {
    return <div>Loading...</div>;
  }

  return (
    <div>
      {/* UI ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */}
      <h1>Call Matrix Dashboard</h1>

      {/* Date Selector */}
      <input
        type="date"
        value={selectedDate}
        onChange={(e) => setSelectedDate(e.target.value)}
      />

      {/* ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á */}
      {matrixData && (
        <table>
          <thead>
            <tr>
              <th>Agent</th>
              {matrixData.time_slots.map((slot) => (
                <th key={slot}>{slot}</th>
              ))}
              <th>‡∏£‡∏ß‡∏°</th>
            </tr>
          </thead>
          <tbody>
            {Object.entries(matrixData.matrix_data).map(([agentId, calls]) => (
              <tr key={agentId}>
                <td>{agentId}</td>
                {matrixData.time_slots.map((slot) => (
                  <td
                    key={slot}
                    onClick={() =>
                      handleUpdateCell(agentId, slot, calls[slot] + 1)
                    }
                    style={{ cursor: "pointer" }}
                  >
                    {calls[slot] || 0}
                  </td>
                ))}
                <td>{matrixData.totals_by_agent[agentId]}</td>
              </tr>
            ))}
          </tbody>
          <tfoot>
            <tr>
              <th>‡∏£‡∏ß‡∏°</th>
              {matrixData.time_slots.map((slot) => (
                <th key={slot}>{matrixData.totals_by_slot[slot]}</th>
              ))}
              <th>{matrixData.grand_total}</th>
            </tr>
          </tfoot>
        </table>
      )}
    </div>
  );
}
```

---

## üß™ ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö API

### ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ cURL

```bash
# 1. Health Check
curl https://believable-ambition-production.up.railway.app/health

# 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Call Matrix ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
curl https://believable-ambition-production.up.railway.app/api/call-matrix

# 3. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
curl https://believable-ambition-production.up.railway.app/api/call-matrix?date=2025-11-18

# 4. ‡∏î‡∏∂‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏≠‡∏á Agent 101
curl https://believable-ambition-production.up.railway.app/api/call-matrix/agent/101

# 5. ‡∏î‡∏∂‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 9-10
curl https://believable-ambition-production.up.railway.app/api/call-matrix/time-slot/9-10

# 6. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£
curl -X POST https://believable-ambition-production.up.railway.app/api/call-matrix/log \
  -H "Content-Type: application/json" \
  -d '{"agent_id":"101"}'

# 7. ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£
curl -X POST https://believable-ambition-production.up.railway.app/api/call-matrix/update \
  -H "Content-Type: application/json" \
  -d '{"agent_id":"101","time_slot":"9-10","value":5}'

# 8. Batch Update
curl -X POST https://believable-ambition-production.up.railway.app/api/call-matrix/batch-update \
  -H "Content-Type: application/json" \
  -d '{
    "updates": [
      {"agent_id":"101","time_slot":"9-10","value":5},
      {"agent_id":"102","time_slot":"10-11","value":8}
    ]
  }'
```

### ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Python

```python
import requests

API_URL = "https://believable-ambition-production.up.railway.app"

# 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Call Matrix
response = requests.get(f"{API_URL}/api/call-matrix")
print(response.json())

# 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£
response = requests.post(
    f"{API_URL}/api/call-matrix/log",
    json={"agent_id": "101"}
)
print(response.json())

# 3. ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£
response = requests.post(
    f"{API_URL}/api/call-matrix/update",
    json={
        "agent_id": "101",
        "time_slot": "9-10",
        "value": 5
    }
)
print(response.json())
```

---

## üìä API Endpoints Summary

| Endpoint                           | Method | Description           | Parameters                           |
| ---------------------------------- | ------ | --------------------- | ------------------------------------ |
| `/health`                          | GET    | Health check          | -                                    |
| `/api/call-matrix`                 | GET    | ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Call Matrix | `date` (optional)                    |
| `/api/call-matrix/agent/:id`       | GET    | ‡∏î‡∏∂‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏≠‡∏á Agent      | `date` (optional)                    |
| `/api/call-matrix/time-slot/:slot` | GET    | ‡∏î‡∏∂‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤       | `date` (optional)                    |
| `/api/call-matrix/log`             | POST   | ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£          | `agent_id`, `call_type`, `time_slot` |
| `/api/call-matrix/update`          | POST   | ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£     | `agent_id`, `time_slot`, `value`     |
| `/api/call-matrix/batch-update`    | POST   | ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡πà‡∏≠‡∏á        | `updates[]`                          |

---

## üîß Troubleshooting

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: Google Sheets Permission Denied

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**

1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Service Account ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Google Sheets
2. ‡πÅ‡∏ä‡∏£‡πå Google Sheets ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö Service Account Email
3. ‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Editor

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: CORS Error

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**

```python
# ‡πÉ‡∏ô app.py
from flask_cors import CORS

# Allow specific origins
CORS(app, origins=['https://your-frontend.vercel.app'])
```

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: Railway Build Failed

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**

1. ‡πÄ‡∏ä‡πá‡∏Ñ `requirements.txt` ‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
2. ‡πÄ‡∏ä‡πá‡∏Ñ `Procfile` syntax ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
3. ‡∏î‡∏π Build Logs ‡∏ö‡∏ô Railway Dashboard

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: Private Key Format Error

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**

```bash
# ‡πÉ‡∏ô .env ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ \\n ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö newline
GOOGLE_SERVICE_ACCOUNT_PRIVATE_KEY=-----BEGIN PRIVATE KEY-----\\nYour_Key\\n-----END PRIVATE KEY-----

# ‡∏ö‡∏ô Railway ‡πÉ‡∏ä‡πâ \n (single backslash)
GOOGLE_SERVICE_ACCOUNT_PRIVATE_KEY=-----BEGIN PRIVATE KEY-----\nYour_Key\n-----END PRIVATE KEY-----
```

---

## üìà ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡∏¢‡∏≤‡∏¢‡∏£‡∏∞‡∏ö‡∏ö

### 1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£ Cache ‡∏î‡πâ‡∏ß‡∏¢ Redis

```python
import redis
import json

redis_client = redis.Redis(host='localhost', port=6379, db=0)

def get_call_matrix_cached(date=None):
    cache_key = f"call_matrix:{date or 'today'}"

    # Check cache
    cached = redis_client.get(cache_key)
    if cached:
        return json.loads(cached)

    # Fetch from Google Sheets
    data = sheets_service.read_call_matrix(date)

    # Cache for 5 minutes
    redis_client.setex(cache_key, 300, json.dumps(data))

    return data
```

### 2. ‡πÄ‡∏û‡∏¥‡πà‡∏° Authentication

```python
from functools import wraps
from flask import request

def require_api_key(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        api_key = request.headers.get('X-API-Key')
        if api_key != os.getenv('API_KEY'):
            return jsonify({'error': 'Invalid API key'}), 401
        return f(*args, **kwargs)
    return decorated_function

@app.route('/api/call-matrix', methods=['GET'])
@require_api_key
def get_call_matrix():
    # ...
```

### 3. ‡πÄ‡∏û‡∏¥‡πà‡∏° Rate Limiting

```python
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address

limiter = Limiter(
    app=app,
    key_func=get_remote_address,
    default_limits=["200 per day", "50 per hour"]
)

@app.route('/api/call-matrix/log', methods=['POST'])
@limiter.limit("10 per minute")
def log_call():
    # ...
```

### 4. ‡πÄ‡∏û‡∏¥‡πà‡∏° Webhook Notifications

```python
import requests

def send_webhook(event_type, data):
    webhook_url = os.getenv('WEBHOOK_URL')
    if webhook_url:
        requests.post(webhook_url, json={
            'event': event_type,
            'data': data,
            'timestamp': datetime.now().isoformat()
        })

# ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
def log_call(agent_id, call_type, time_slot):
    result = sheets_service.update_call_count(agent_id, time_slot)

    if result.get('success'):
        send_webhook('call_logged', {
            'agent_id': agent_id,
            'time_slot': time_slot
        })

    return result
```

---

## üîê Security Best Practices

1. **‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢ Credentials** - ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Environment Variables
2. **‡πÉ‡∏ä‡πâ HTTPS ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô** - Railway ‡∏°‡∏µ SSL certificate ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
3. **‡πÄ‡∏û‡∏¥‡πà‡∏° API Key Authentication** - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö production
4. **Rate Limiting** - ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô abuse
5. **Input Validation** - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö input ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
6. **Error Handling** - ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ú‡∏¢‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î internal error
7. **Logging & Monitoring** - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å access logs

---

## üìö Additional Resources

- [Flask Documentation](https://flask.palletsprojects.com/)
- [Google Sheets API Python](https://developers.google.com/sheets/api/quickstart/python)
- [gspread Documentation](https://docs.gspread.org/)
- [Railway Documentation](https://docs.railway.app/)
- [Flask-CORS](https://flask-cors.readthedocs.io/)

---

## ‚úÖ Checklist ‡∏Å‡∏≤‡∏£ Deploy

- [ ] ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á dependencies (`requirements.txt`)
- [ ] ‡∏™‡∏£‡πâ‡∏≤‡∏á Google Service Account
- [ ] ‡πÅ‡∏ä‡∏£‡πå Google Sheets ‡πÉ‡∏´‡πâ Service Account
- [ ] ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Environment Variables
- [ ] ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API ‡πÉ‡∏ô local (`python app.py`)
- [ ] ‡∏™‡∏£‡πâ‡∏≤‡∏á Procfile, runtime.txt, railway.json
- [ ] Push code ‡∏Ç‡∏∂‡πâ‡∏ô GitHub
- [ ] Deploy ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Railway
- [ ] ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Environment Variables ‡∏ö‡∏ô Railway
- [ ] ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API endpoints
- [ ] ‡πÄ‡∏û‡∏¥‡πà‡∏° `NEXT_PUBLIC_PYTHON_API_URL` ‡πÉ‡∏ô Vercel
- [ ] Redeploy Frontend
- [ ] ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Frontend-Backend

---

**‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢:** Film Developer Team  
**‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:** 18 ‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô 2025  
**‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô:** 1.0.0
